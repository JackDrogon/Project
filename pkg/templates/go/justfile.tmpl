#!/usr/bin/env -S just --justfile

# Justfile for {{.ProjectName}}
# Run `just` or `just --list` to see available recipes

tag := `git describe --abbrev=0 --always --tags`
ldflags := "-X '{{.ModulePath}}/pkg/version.GitTagSha=" + tag + "'"

# ─────────────────────────────────────────────────────────────────────
# Aliases
# ─────────────────────────────────────────────────────────────────────

alias b := build
alias t := test
alias l := lint
alias f := fmt
alias r := run

# Show all available recipes
[private]
default:
    @just --list --unsorted

# ═════════════════════════════════════════════════════════════════════
#  Build
# ═════════════════════════════════════════════════════════════════════

# Build binary to bin/{{.ProjectName}}
[group('build')]
build:
    @mkdir -p bin
    go build -ldflags "{{"{{ldflags}}"}}" -o bin/{{.ProjectName}} .

# Build with coverage instrumentation
[group('build')]
build-cover:
    @mkdir -p bin
    go build -ldflags "{{"{{ldflags}}"}}" -cover -o bin/{{.ProjectName}} .

# Remove build artifacts
[group('build')]
clean:
    rm -rf bin

# ═════════════════════════════════════════════════════════════════════
#  Code Quality
# ═════════════════════════════════════════════════════════════════════

# Run golangci-lint
[group('quality')]
lint:
    golangci-lint run

# Format all Go code
[group('quality')]
fmt:
    go fmt ./...

# ═════════════════════════════════════════════════════════════════════
#  Test
# ═════════════════════════════════════════════════════════════════════

# Run tests
[group('test')]
test pkg='./...':
    go test {{"{{pkg}}"}}

# Run tests with verbose output
[group('test')]
test-v pkg='./...':
    go test -v {{"{{pkg}}"}}

# ═════════════════════════════════════════════════════════════════════
#  Run
# ═════════════════════════════════════════════════════════════════════

# Build and run (e.g., just run -- --help)
[group('run')]
run *args: build
    ./bin/{{.ProjectName}} {{"{{args}}"}}

# ═════════════════════════════════════════════════════════════════════
#  Maintenance
# ═════════════════════════════════════════════════════════════════════

# Count lines of code (requires tokei)
[group('maintenance')]
loc:
    tokei --sort code

# Print all TODOs in codebase
[group('maintenance')]
todos:
    grep -rnw . -e "TODO" | grep -v '^./.git'
